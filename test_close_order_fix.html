<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Fechar Pedido</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Teste - Popup Fechar Pedido</h2>
        <p>Este teste verifica se o problema do diálogo de arquivos foi corrigido.</p>
        
        <button class="btn btn-primary" onclick="testarFecharPedido()">
            Testar Fechar Pedido Individual
        </button>
        
        <button class="btn btn-success" onclick="testarFecharMesa()">
            Testar Fechar Mesa Completa
        </button>
        
        <div id="resultado" class="mt-3"></div>
    </div>

    <script>
        function testarFecharPedido() {
            console.log('Testando fechar pedido individual...');
            
            Swal.fire({
                title: 'Fechar Pedido Individual',
                html: `
                    <div class="mb-3">
                        <label class="form-label"><strong>Valor Total: R$ 41,00</strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="formaPagamento" onchange="toggleValorPago()" required>
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão Débito">Cartão Débito</option>
                            <option value="Cartão Crédito">Cartão Crédito</option>
                            <option value="PIX">PIX</option>
                            <option value="Fiado">Fiado (Crédito)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome do Cliente (opcional)</label>
                        <input type="text" class="form-control" id="nomeCliente" placeholder="Nome do cliente" autocomplete="off" tabindex="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone (opcional)</label>
                        <input type="text" class="form-control" id="telefoneCliente" placeholder="(11) 99999-9999" autocomplete="off" tabindex="2">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observação</label>
                        <textarea class="form-control" id="observacao" rows="2" placeholder="Observações sobre o pagamento..." autocomplete="off" tabindex="3"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Fechar Pedido',
                cancelButtonText: 'Cancelar',
                width: '500px',
                allowOutsideClick: false,
                allowEscapeKey: true,
                focusConfirm: false,
                didOpen: () => {
                    console.log('Popup aberto - configurando campos...');
                    setTimeout(() => {
                        const allInputs = document.querySelectorAll('input, textarea, select');
                        allInputs.forEach(input => {
                            input.disabled = false;
                            input.readOnly = false;
                            input.style.pointerEvents = 'auto';
                            input.style.cursor = 'text';
                            input.style.zIndex = '9999';
                            
                            input.removeAttribute('readonly');
                            input.removeAttribute('disabled');
                        });
                        
                        const firstInput = document.querySelector('#nomeCliente');
                        if (firstInput) {
                            firstInput.focus();
                        }
                        console.log('Campos configurados!');
                    }, 200);
                },
                preConfirm: () => {
                    const formaPagamento = document.getElementById('formaPagamento').value;
                    const nomeCliente = document.getElementById('nomeCliente').value;
                    const telefoneCliente = document.getElementById('telefoneCliente').value;
                    const observacao = document.getElementById('observacao').value;
                    
                    if (!formaPagamento) {
                        Swal.showValidationMessage('Forma de pagamento é obrigatória');
                        return false;
                    }
                    
                    return { formaPagamento, nomeCliente, telefoneCliente, observacao };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('Dados capturados:', result.value);
                    
                    // Simular envio sem FormData (que causava o problema)
                    const params = new URLSearchParams();
                    params.append('action', 'fechar_pedido_individual');
                    params.append('id_pedido', '123');
                    params.append('forma_pagamento', result.value.formaPagamento);
                    params.append('nome_cliente', result.value.nomeCliente);
                    params.append('telefone_cliente', result.value.telefoneCliente);
                    params.append('observacoes', result.value.observacao);
                    
                    document.getElementById('resultado').innerHTML = `
                        <div class="alert alert-success">
                            <h5>✅ Teste Concluído com Sucesso!</h5>
                            <p><strong>Problema resolvido:</strong> Não houve abertura de diálogo de arquivos.</p>
                            <p><strong>Dados capturados:</strong></p>
                            <ul>
                                <li>Forma de Pagamento: ${result.value.formaPagamento}</li>
                                <li>Nome: ${result.value.nomeCliente || '(não informado)'}</li>
                                <li>Telefone: ${result.value.telefoneCliente || '(não informado)'}</li>
                                <li>Observação: ${result.value.observacao || '(não informado)'}</li>
                            </ul>
                            <p><strong>Método usado:</strong> URLSearchParams (sem FormData)</p>
                        </div>
                    `;
                } else {
                    document.getElementById('resultado').innerHTML = `
                        <div class="alert alert-info">
                            <p>Teste cancelado pelo usuário.</p>
                        </div>
                    `;
                }
            });
        }
        
        function testarFecharMesa() {
            console.log('Testando fechar mesa completa...');
            
            Swal.fire({
                title: 'Fechar Mesa Completa',
                html: `
                    <div class="mb-3">
                        <label class="form-label"><strong>Valor Total: R$ 85,50</strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="formaPagamento" required>
                            <option value="">Selecione a forma de pagamento</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão Débito">Cartão Débito</option>
                            <option value="Cartão Crédito">Cartão Crédito</option>
                            <option value="PIX">PIX</option>
                            <option value="Fiado">Fiado (Crédito)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome do Cliente (opcional)</label>
                        <input type="text" class="form-control" id="nomeCliente" placeholder="Nome do cliente" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Telefone (opcional)</label>
                        <input type="text" class="form-control" id="telefoneCliente" placeholder="(11) 99999-9999" autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observação</label>
                        <textarea class="form-control" id="observacao" rows="2" placeholder="Observações sobre o pagamento..." autocomplete="off"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Fechar Mesa',
                cancelButtonText: 'Cancelar',
                width: '500px',
                didOpen: () => {
                    setTimeout(() => {
                        const allInputs = document.querySelectorAll('input, textarea, select');
                        allInputs.forEach(input => {
                            input.disabled = false;
                            input.readOnly = false;
                            input.style.pointerEvents = 'auto';
                            input.style.cursor = 'text';
                            input.style.zIndex = '9999';
                        });
                        
                        const firstInput = document.querySelector('#nomeCliente');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    }, 200);
                },
                preConfirm: () => {
                    const formaPagamento = document.getElementById('formaPagamento').value;
                    const nomeCliente = document.getElementById('nomeCliente').value;
                    const telefoneCliente = document.getElementById('telefoneCliente').value;
                    const observacao = document.getElementById('observacao').value;
                    
                    if (!formaPagamento) {
                        Swal.showValidationMessage('Forma de pagamento é obrigatória');
                        return false;
                    }
                    
                    return { formaPagamento, nomeCliente, telefoneCliente, observacao };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('resultado').innerHTML = `
                        <div class="alert alert-success">
                            <h5>✅ Teste Mesa Completa - Sucesso!</h5>
                            <p><strong>Problema resolvido:</strong> Não houve abertura de diálogo de arquivos.</p>
                            <p><strong>Dados capturados:</strong></p>
                            <ul>
                                <li>Forma de Pagamento: ${result.value.formaPagamento}</li>
                                <li>Nome: ${result.value.nomeCliente || '(não informado)'}</li>
                                <li>Telefone: ${result.value.telefoneCliente || '(não informado)'}</li>
                                <li>Observação: ${result.value.observacao || '(não informado)'}</li>
                            </ul>
                        </div>
                    `;
                }
            });
        }
        
        function toggleValorPago() {
            // Função placeholder para o teste
        }
    </script>
</body>
</html>
